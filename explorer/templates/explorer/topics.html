{% extends "explorer/base.html" %}

{% load staticfiles %}


{% block extrahead %}
<script src="{% static 'explorer/js/spin.min.js' %}"></script>
<script src="{% static 'explorer/js/jquery.spin.js' %}"></script>
<script src="{% static 'explorer/js/cytoscape.min.js' %}"></script>

<script>
// While awaiting a response to an ajax request, a spinner is shown in the
//  network visualization panel.
var opts = {
  lines: 13 // The number of lines to draw
, length: 21 // The length of each line
, width: 14 // The line thickness
, radius: 42 // The radius of the inner circle
, scale: 1 // Scales overall size of the spinner
, corners: 1 // Corner roundness (0..1)
, color: '#577492' // #rgb or #rrggbb or array of colors
, opacity: 0.25 // Opacity of the lines
, rotate: 0 // The rotation offset
, direction: 1 // 1: clockwise, -1: counterclockwise
, speed: 1 // Rounds per second
, trail: 62 // Afterglow percentage
, fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
, zIndex: 2e9 // The z-index (defaults to 2000000000)
, className: 'spinner' // The CSS class to assign to the spinner
, top: '40%' // Top position relative to parent
, left: '50%' // Left position relative to parent
, shadow: false // Whether to render a shadow
, hwaccel: false // Whether to use hardware acceleration
, position: 'absolute' // Element positioning
}

$(document)
    .ajaxStart(function () {
        $('#networkVisContainer').spin(opts);

    })
    .ajaxStop(function () {
        $('#networkVisContainer').spin(false);
    });


var startYear = 1975;
var endYear = 1990;

// When the page is loaded, request the topic colocation network.
$('body').ready(function() {
    var buildGraph = function(startYear, endYear) {
        $.ajax('?data=graph&startyear=' + startYear + '&endyear=' + endYear, {
            success: function(elements) {
                // When the data is returned, generate an interative visualization
                //  using Cytoscape.js.
                var cy = cytoscape({
                    container: $('#cyTopics'),
                    elements: elements,
                    minZoom: 0.5,
                    maxZoom: 3,
                    style: [    // The stylesheet for the graph.
                        {
                            // Node size is a function of topic prevalence.
                            selector: 'node',
                            style: {
                                'background-color': '#B74934',
                                'label': 'data(id)',
                                'width': 'mapData(weight, 0.0, 0.1, 20, 35)',
                                'height': 'mapData(weight, 0.0, 0.1, 20, 35)',
                                'font-size': 'mapData(weight, 0.0, 0.1, 8, 36)'
                            }
                        },
                        {
                            selector: 'node.connectedNodes',
                            style: {
                                opacity: 1.0,
                                'border-color': '#AA9A66',
                                'border-width': 2,
                            }
                        },
                        {
                            selector: 'node.nonConnectedNodes',
                            style: {
                                'opacity': 0.5,
                            }
                        },
                        {
                            // When a node is selected, it should be slightly larger
                            //  and have a colored border.
                            selector: 'node:selected',
                            style: {
                                'border-color': '#AA9A66',
                                'border-width': 4,
                                'width': 'mapData(weight, 0.0, 0.1, 30, 60)',
                                'height': 'mapData(weight, 0.0, 0.1, 30, 60)',
                            }
                        },
                        {
                            // Active nodes should be slightly larger.
                            selector: 'node:active',
                            style: {
                                'width': 'mapData(weight, 0.0, 0.5, 30, 60)',
                                'height': 'mapData(weight, 0.0, 0.5, 30, 60)',
                            }
                        },
                        {
                            // Edge weight is a function of nPMI.
                            selector: 'edge',
                            style: {
                                'width': 'mapData(weight, 0.1, 0.5, 0.5, 6)',
                                'opacity': 'mapData(weight, 0.1, 0.5, 0.1, 1)',
                                'line-color': '#67655D',
                                'target-arrow-color': '#ccc',
                            }
                        },
                        {
                            selector: 'edge.connectedEdge',
                            style: {
                                'opacity': 1,
                                'line-color': '#AA9A66',
                                'z-index': 500,
                                'width': 'mapData(weight, 0.1, 0.5, 1, 12)',
                            }
                        },
                        {
                            // A selected edge should be slightly thicker, and be
                            //  colored a brighter color.
                            selector: 'edge:selected',
                            style: {
                                'width': 'mapData(weight, 0.1, 0.5, 2, 8)',
                                'opacity': 1,
                                'line-color': '#AA9A66',
                            }
                        },
                    ],

                    // The CoSE layout is a force-directed layout.
                    layout: {
                        name: 'preset',
                        positions: function(d) {
                            return d._private.data.pos;
                        },
                        // nodeOverlap: 20,
                        // idealEdgeLength: function( edge ){ return  2./(edge.weight); },
                        // edgeElasticity: function( edge ){ return 1000; },
                        boundingBox:  { x1: 0, y1: 0, w: 900, h: 900},
                        // gravity: 50,
                        // numIter: 5000,
                    }
                });

                var clearSelectedTopics = function() {
                    $('.topic-details').css('visibility', 'hidden');
                    $('#topic-details-terms-2-list').empty();
                    $('#topic-details-heading-2').empty();
                    $('.topic-details-2').css('visibility', 'hidden');


                    $('#topic-details-terms-1-list').empty();
                    $('#topic-details-heading-1').empty();
                    $('#topic-details-1-link').css('visibility', 'hidden');
                    $('.topic-details-1').css('visibility', 'hidden');

                    $('#topic-details-documents').empty();

                    $('#topic-details-documents-heading').empty();

                    d3.selectAll('.stream')
                        .classed('stream-muted', false);
                    d3.selectAll('.stream-highlighted')
                        .classed('stream-highlighted', false);

                    cy.elements('edge').edges().removeClass('connectedEdge');
                    cy.elements('edge').edges().removeClass('nonConnected');
                    cy.elements('edge').edges().unselect();
                    cy.elements('node').nodes().removeClass('connectedNodes');
                    cy.elements('node').nodes().removeClass('nonConnectedNodes');
                    cy.elements('node').nodes().unselect();
                }

                // When a node is clicked, information about the corresponding topic
                //  is displayed in a neighboring panel.
                cy.on( 'click', 'node', function(event) {
                    clearSelectedTopics();

                    var node = event.cyTarget;  // The node that was clicked.
                    $('.topic-details').css('visibility', 'visible');
                    $('#topic-details-documents-heading').text('Occurs in...');
                    $('#topic-details-heading-1')
                        .text('Topic ' + node._private.data.id);

                    node._private.data.terms.forEach(function(term) {
                        $('#topic-details-terms-1-list')
                            .append('<li class="topic-details-term" style="font-size: '+ term.weight*1.5 +';">' + term.term + '</li>');
                    });
                    $('#topic-details-1-link').attr('href', '/topics/' + node._private.data.id + '/');
                    $('#topic-details-1-link').css('visibility', 'visible');

                    node._private.data.documents.forEach(function(doc) {
                        $('#topic-details-documents')
                            .append('<li class="topic-details-document"><a href="/documents/'+ doc.id +'/">(' + doc.pubdate + ') '+ doc.title +'</a></li>');
                    });


                    d3.selectAll('.stream')
                        .classed('stream-muted', true);

                    d3.select('#topic-stream-area-' + node._private.data.id)
                        .classed('stream-muted', false)
                        .classed('stream-highlighted', true);

                    var directlyConnected = node.neighborhood();
                    var nonConnected = cy.elements().difference( directlyConnected );

                    directlyConnected.nodes().addClass('connectedNodes');
                    nonConnected.nodes().addClass('nonConnectedNodes');
                    node.removeClass('nonConnectedNodes');

                    node.neighborhood('edge').edges().addClass('connectedEdge');

                });

                cy.on('click', 'edge', function(event) {
                    clearSelectedTopics();

                    var edge = event.cyTarget;  // The edge that was clicked.
                    $('.topic-details').css('visibility', 'visible');
                    $('.topic-details-2').css('visibility', 'visible');

                    $('#topic-details-heading-1').text('Topic ' + edge._private.source._private.data.id);
                    $('#topic-details-heading-2').text('Topic ' + edge._private.target._private.data.id);
                    $('#topic-details-documents-heading').text('Occur together in...');


                    edge._private.source._private.data.terms.forEach(function(term) {
                        $('#topic-details-terms-1-list').append('<li class="topic-details-term" style="font-size: '+ term.weight*1.5 +';">' + term.term + '</li>');
                    });

                    edge._private.target._private.data.terms.forEach(function(term) {
                        $('#topic-details-terms-2-list').append('<li class="topic-details-term" style="font-size: '+ term.weight*1.5 +';">' + term.term + '</li>');
                    });

                    edge._private.data.documents.forEach(function(doc) {
                        $('#topic-details-documents').append('<li class="topic-details-document"><a href="/documents/'+ doc.id +'/">(' + doc.pubdate + ') '+ doc.title +'</a></li>');
                    });
                    $('#topic-details-1-link').css('visibility', 'hidden');

                    cy.elements('edge').edges().addClass('nonConnected');
                    cy.elements('node').nodes().addClass('nonConnectedNodes');
                    edge._private.source.addClass('connectedNodes');
                    edge._private.source.removeClass('nonConnectedNodes');
                    edge._private.target.addClass('connectedNodes');
                    edge._private.target.removeClass('nonConnectedNodes');

                    d3.selectAll('.stream')
                        .classed('stream-muted', true);

                    d3.select('#topic-stream-area-' + edge._private.target._private.data.id)
                        .classed('stream-muted', false)
                        .classed('stream-highlighted', true);
                    d3.select('#topic-stream-area-' + edge._private.source._private.data.id)
                        .classed('stream-muted', false)
                        .classed('stream-highlighted', true);
                });

                // When the esc key is pressed, clear all selections.
                $(document).keyup(function(e) {
                     if (e.keyCode == 27) {
                        clearSelectedTopics();
                    }
                });

            }
        });
    }
    buildGraph(startYear, endYear);
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })

    var layers,
        years,
        m,
        n=20,
        brushPos = [47-(2013-startYear), 47-(2013-endYear)],
        stack = d3.layout.stack().offset("wiggle");

        var color = ["#AA9A66", "#B74934", "#221100", "#577492", "#67655D", "#332C2F", "#A81A00", "#4C3F3D", "#996622", "#117788",
                     "#AA9A66", "#B74934", "#221100", "#577492", "#67655D", "#332C2F", "#A81A00", "#4C3F3D", "#996622", "#117788",
                     "#AA9A66", "#B74934", "#221100", "#577492", "#67655D", "#332C2F", "#A81A00", "#4C3F3D", "#996622", "#117788"];
    var thisColor = color[Math.floor(Math.random() * color.length)];

    var redraw = function() {
        var width = parseInt(d3.select('#topic-stream').style('width'), 10),
            height = parseInt(d3.select('#topic-stream').style('height'), 10);

        var x = d3.scale.linear()
            .domain([0, m - 1])
            .range([0, width]);

        var y = d3.scale.linear()
            .domain([0, d3.max(layers, function(layer) {return d3.max(layer.layer, function(d) { return d.y0 + d.y; }); })])
            .range([height, 0]);

        var area = d3.svg.area()
            .interpolate("cardinal")
            .x(function(d) { return x(d.x); })
            .y0(function(d) { return y(d.y0); })
            .y1(function(d) { return y(d.y0 + d.y); });

        var axis = d3.svg.axis()
            .scale(x)
            .orient("top")
            .tickFormat(function(d, i) {
                return String(years[d]);
            });

        var svg = d3.select("#topic-stream").append("svg")
            .attr("width", width)
            .attr("height", height);

        svg.selectAll("path")
            .data(layers)
            .enter().append("path")
            .attr("d", function(d) {
                return area(d.layer);
            })
            .style("fill", function() {
                return color[Math.floor(Math.random() * color.length)];
            })
            .classed('stream', true)
            .attr("id", function(d) {
                // So that we can highlight the stream when the user clicks a node.
                return 'topic-stream-area-' + String(d.t);
            });



        svg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + height + ")")
            .call(axis)
                .selectAll('text')  // Rotate and reposition x axis labels.
                .attr("transform", "rotate(-90)" )
                    .attr("dx", height/2)
                    .attr("dy", "1.7em");


        var brush = d3.svg.brush()
            .x(x)
            .extent(brushPos)
            .on("brushstart", brushstart)
            .on("brush", brushmove)
            .on("brushend", brushend);

        var muteLeft = svg.append("rect")
            .classed('mute', true)
            .attr('fill', '#fff')
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 0)
            .attr("height", height);

        var muteRight = svg.append("rect")
            .classed('mute', true)
            .attr('fill', '#fff')
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 0)
            .attr("height", height);

        var arc = d3.svg.arc()
            .outerRadius(height / 8)
            .startAngle(0)
            .endAngle(function(d, i) { return i ? -Math.PI : Math.PI; });

        var brushg = svg.append("g")
                .attr("class", "brush")
                .call(brush);

        brushg.selectAll(".resize").append("path")
            .attr("transform", "translate(0," +  height / 2 + ")")
            .attr("d", arc);

        brushg.selectAll("rect")
            .attr("height", height-1);

        brushstart();
        brushmove();

        function brushstart() {
          svg.classed("selecting", true);
        }

        function brushmove() {
          var s = brush.extent();
          brushPos = s;

          muteLeft.attr('width', x(s[0]));
          muteRight.attr('x', x(s[1]));
          muteRight.attr('width', width - x(s[1]));
        //   circle.classed("selected", function(d) { return s[0] <= d && d <= s[1]; });
        }

        function brushend() {
            var s = brush.extent();
            s = [Math.round(s[0]), Math.round(s[1])];
            d3.select(this).transition()
                .call(brush.extent(s));
            brushmove();
                // .call(brush.event);
            // console.log(s);
            // d3.select(this).transition()
            //     .call();
            // muteRight.attr('x', x(s[1]));
            // muteRight.attr('width', width - x(s[1]));
            buildGraph(1968 + s[0], 1968 + s[1]);
          svg.classed("selecting", !d3.event.target.empty());
        }

    }

    function transition() {
        d3.selectAll("path")
            .data(function() {
                var d = layers1;
                layers1 = layers0;
                return layers0 = d;
            })
            .transition()
            .duration(2500)
            .attr("d", area);
    }

    function resize() {
        $("#topic-stream").empty();
        redraw();
    }


    d3.json("/topics/?data=time", function(data) {

        n = data.topics.length
        m = data.topics[0].values.length; // number of samples per layer

        var dataLayer = function(dt) {
            var a = [], i;
            for (i = 0; i < m; ++i) a[i] = 0;

            var series = a.map(function(d, i) {
                return {
                    x: i,
                    y0: 0,
                    y: data.topics[dt].values[i]
                };
            });
            return series;
        }
        layers = stack(d3.range(data.topics.length).map(function(dt) { return dataLayer(dt); })).map(function(l, i) { return {t: i, layer:l }; });

        years = data.topics[0].dates;
        redraw(layers);

        d3.select(window).on('resize', resize);

    });

});
</script>
<style>
#topic-stream-container {
  /*background: url('{% static "explorer/images/network.png" %}') no-repeat center center;*/
  background-color: white;
    position: absolute;
    padding-top: 5px;
    padding-bottom: 5px;
    width: 100%;
    top: 50;
    left:0;


    border-width: 0 0 10px 0;
        -webkit-border-image:
            -webkit-gradient(linear, 100% 0, 0 0, from(white), to(#D4D8D1)) 100% 1;
        -webkit-border-image:
            -webkit-linear-gradient(top, white, #D4D8D1) 100% 1;
        -o-border-image:
                 -o-linear-gradient(top, white, #D4D8D1) 100% 1;
}
#topic-stream {
    height: 140px;
}
</style>
{% endblock %}

{% block content %}
<!-- <div class="container-fluid">
    <div class="panel"> -->
<div id="topic-stream-container">
    <span class="pull-right" style="width: 50px;">
        <button type="button" class="btn btn-primary btn-xs" aria-label="Info" data-toggle="modal" data-target="#infoModal">
            <span class="glyphicon glyphicon-info-sign" aria-hidden="true" data-toggle="tooltip" data-placement="left" title="What am I looking at?"></span>
        </button>

    </span>
    <div id="topic-stream">
    </div>
    <h1 class="h1 display-1 page-title">The Topic Model Browser<h1>
</div>
    <!-- </div>
</div> -->
<div class="container-fluid" style="margin-top: 235px;">
    <div class="row">
        <div class="col-sm-8" id="networkVisContainer">
            <div id="cyTopics" style="height: 400px;">
            </div>
            <p class="text text-muted text-small">
                Use your mouse wheel or track pad to zoom in and out. Click on a topic
                to view details. Click on an edge between two topics for details about
                their relationship.
            </p>
        </div>
        <div class="col-sm-4">
            <div class="panel topic-details" style="visibility: hidden;">
                <div class="panel-heading clearfix">
                    <span class="h4" id="topic-details-heading-1"></span>
                    <span class="pull-right btn-group">
                        <a id="topic-details-1-link" type="button" href="" class="btn btn-default btn-xs" aria-label="Details">
                            <span class="glyphicon glyphicon-stats" aria-hidden="true"></span> Details
                        </a>
                    </span>
                </div>
                <div class="panel-body" id="topic-details-terms-1">
                    <ul id="topic-details-terms-1-list" class="topic-details-terms-list">
                    </ul>
                </div>
                <div class="panel topic-details-2" style="visibility: hidden;">
                    <span class="h4" id="topic-details-heading-2"></span>
                </div>
                <div class="panel-body topic-details-2" id="topic-details-terms-2" style="visibility: hidden;">
                    <ul id="topic-details-terms-2-list" class="topic-details-terms-list">
                    </ul>
                </div>
            </div>
            <div class="panel topic-details" style="visibility: hidden;">
                <div class="panel-heading h4" id="topic-details-documents-heading"></div>
                <div class="panel-body">
                    <ul id="topic-details-documents">
                    </ul>
                    <span class="pull-right"><a href="#">More...</a></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">The Topic Co-Location Graph</h4>
            </div>
            <div class="modal-body">
                <p>
                    This graph shows all of the topics in the JHB Explorer <a href="#" data-toggle="tooltip" data-placement="top" title="What's that?">topic model</a>,
                    and how those topics co-occur across the <em>Journal of the History of Biology</em> corpus.
                </p>
                <p>
                    Each topic is represented by a bubble, known to graph-theory nerds as a <strong>"node"</strong>. If you click on a node, information about the
                    correspoding topic will be shown at right. Each line between a pair of nodes is known as an <strong>"edge"</strong>. If there is an edge between
                    two nodes, that means that the two corresponding topics frequently occur together (they are <strong>"co-located"</strong>) on pages in <em>JHB</em>.
                </p>
                <p>
                    The width and opacity of each edge corresponds to the <strong><a href="#"  data-toggle="tooltip" data-placement="top" title="Huh?">normalized
                    pointwise mutual information (nPMI)</a></strong> statistic for the two corresponding topics. The higher the nPMI, the more likely it is that
                    the listed topic and the current topic are related in some way. An edge is drawn between two topics only if their nPMI is in the upper 98th
                    percentile. nPMI is more useful than simply looking at how frequently two topics occur together, because it takes into account the probability
                    that two topics will occur together simply by chance (e.g. because one topic is very prominent in the corpus).
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>


</script>
{% endblock %}
